
variables:
  APP_NAME: aiw-ui-admin-capstan

stages:
  - build
 
default:
  tags:
    - test-runner

include:
  - project: capstan/pow/gitlab-templates
    file: /static-app-deployer/template.yml
    ref: static-app-deployer-v1
  - file: /deploy-selenium-grid/template.yml
    project: capstan/pow/gitlab-templates
    ref: deploy-selenium-grid-v3
  - file: /run-integration-tests/template.yml
    project: capstan/pow/gitlab-templates
    ref: run-integration-tests-v3
  - project: capstan/pow/gitlab-templates
    file: check-healthy-deployment/template.yml
    ref: check-healthy-deployment-v3

build-aiw-ui-app:
  stage: build
  extends: .build-static-app
  image: $DOCKER_VIRTUAL/node:14.21.1
  variables:
    BUILD_SCRIPT_PATH: $CI_PROJECT_DIR/build.sh
    BUILD_OUTPUT_PATH: $CI_PROJECT_DIR/dist/${ENVIRONMENT}

deploy:
  stage: deploy
  extends: .deploy-static-app
  variables:
    BUILD_OUTPUT_PATH: $CI_PROJECT_DIR/dist/test
    ENVIRONMENT: test
  environment:
    name: test
    url: http://${APP_NAME}.apps.test.cirrostratus.org

# deploy grid:
#   stage: verify
#   extends: .deploy-selenium-grid
#   variables:
#     ENVIRONMENT: $ENVIRONMENT

# integration-tests:
#   stage: verify
#   needs:
#     - deploy grid
#   extends: .integration-tests
#   variables:
#     APP_URL: ccu-dashboard
#     RAKE_TASK: "CCU_Dashboard_UI:Integration"
#     TESTS_IMAGE: $DOCKER_VIRTUAL/jstor-fe/cucumber-eks:5287c415aac87f08c38e2a49198c198ef3450477
#     TEST_ROOT_DIR: $CI_PROJECT_DIR/ccu-dashboard/regression_tests
#     ENVIRONMENT: $ENVIRONMENT
#     JUNIT_REPORT_FILENAME_PATTERN: $CI_PROJECT_DIR/ccu-dashboard/regression_tests/features_report/**/*.xml